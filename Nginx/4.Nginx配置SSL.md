# Nginx配置SSL

## 域名备案流程

> 网站整体上线使用流程
>
> - 域名注册：[域名控制台 (aliyun.com)](https://dc.console.aliyun.com/next/index#/overview)
>   - 阿里域名注册指南：[域名注册_域名(Domain)-阿里云帮助中心 (aliyun.com)](https://help.aliyun.com/zh/dws/user-guide/quick-start-1/)
> - SSL证书申请：[数字证书管理服务管理控制台 - 概览 (aliyun.com)](https://yundun.console.aliyun.com/?spm=5176.100251.top-nav.122.35a64f15vlzXbP&p=cas#/overview/cn-hangzhou)
>   - 阿里SSL证书指南：[数字证书管理服务（原SSL证书）(SSL Certificate)-阿里云帮助中心 (aliyun.com)](https://help.aliyun.com/zh/ssl-certificate/)
> - ICP备案：[ICP代备案管理系统 (aliyun.com)](https://beian.aliyun.com/pcContainer/myorder)
>   - 阿里ICP备案指南：[阿里云ICP备案流程概述_备案(ICP Filing)-阿里云帮助中心 (aliyun.com)](https://help.aliyun.com/zh/icp-filing/basic-icp-service/user-guide/icp-filing-application-overview)
> - 公安备案：[我的主页 - 全国互联网安全管理服务平台 (mps.gov.cn)](https://beian.mps.gov.cn/web/dashboard/home)
>   - 阿里公安备案指南：[公安联网备案及注销介绍_备案(ICP Filing)-阿里云帮助中心 (aliyun.com)](https://help.aliyun.com/zh/icp-filing/basic-icp-service/user-guide/the-public-security-network-for-record-and-cancellation)

## 下载证书

![image-20240531155518559](img/4.Nginx配置SSL/image-20240531155518559.png)

## Nginx配置文件

```nginx
	server {
		# 服务器端口使用443，开启ssl
		listen       443 ssl;
		# 域名，多个以空格分开
		server_name  example.com www.example.com;

		# ssl证书地址
		ssl_certificate     /usr/local/nginx/cert/ssl.pem;  # pem文件的路径
		ssl_certificate_key  /usr/local/nginx/cert/ssl.key; # key文件的路径

		# ssl验证相关配置
		ssl_session_timeout  5m;    #缓存有效期
		ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;    #加密算法
		ssl_protocols TLSv1 TLSv1.1 TLSv1.2;    #安全链接可选的加密协议
		ssl_prefer_server_ciphers on;    #使用服务器端的首选算法

		location / {
			root   html;
			index  index.html index.htm;
		}
	}
```

> ![image-20240531155622521](img/4.Nginx配置SSL/image-20240531155622521.png)
>
> 配置SSL之后，需要重启nginx，此时配合域名访问使用就可以成功使用https了
>
> ![image-20240608193344942](img/4.Nginx配置SSL/image-20240608193344942.png)
>
> https只是默认的端口在443，可以通过指定端口号，对应端口号开启了ssl即可
>
> ![image-20240823121344771](img/4.Nginx配置SSL/image-20240823121344771.png)

## 升级TLS协议

> 业务网络环境可能对TLS协议版本协议有要求，需要`TLS 1.2`或者`TLS 1.3`版本
>
> ![image-20240812105518866](img/4.Nginx配置SSL/image-20240812105518866.png)

```nginx
	server {
		listen 443 ssl;
		server_name api-test.cbecdc.com;
		# ssl证书地址
		ssl_certificate     vhost/certificate/api-test.cbecdc/api-test.cbecdc.com_bundle.pem;  # pem文件的路径
		ssl_certificate_key  vhost/certificate/api-test.cbecdc/api-test.cbecdc.com.key; # key文件的路径

		# ssl验证相关配置
		ssl_session_timeout  5m;    #缓存有效期
		# 更新后的加密算法，只包含推荐的加密套件
		ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
		# 更新后的加密协议，移除了不安全的 TLSv1.0 和 TLSv1.1
		ssl_protocols TLSv1.2 TLSv1.3;    # 安全链接可选的加密协议
		ssl_prefer_server_ciphers on;    #使用服务器端的首选算法

		# 为特定的URL匹配请求设置根目录
		location / {
			proxy_set_header Host $http_host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header REMOTE-HOST $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_pass http://localhost:444/;
		}
	}
```

> ![image-20240812105346058](img/4.Nginx配置SSL/image-20240812105346058.png)

## 域名与服务器不在同一服务商

> 参考博客：[报错：Error: read ECONNRESET，要求网站备案的问题解决 - 豆汤 - 博客园 (cnblogs.com)](https://www.cnblogs.com/CarlJohnson9527/p/18265542)
>
> 腾讯和阿里都是信管局的代理商，在腾讯备案信管局通过了，按道理就直接可以查询到域名备案情况和信息。实际情况是信管局的代理商之间是隔离的分裂的，可能也是竞争关系导致，备案和服务器必须要是同一个代理商，比如都是腾讯云，或者都是阿里云

背景：**服务器为阿里云**、**域名为腾讯云**，当不一致的时候除了chrome，手机端和其它浏览器无法正常访问

![image-20240821174440448](img/4.Nginx配置SSL/image-20240821174440448.png)

api工具调用登录接口报错`Error: read ECONNRESET`，代码调用需要通过ip加端口的方式

![image-20240821174245600](img/4.Nginx配置SSL/image-20240821174245600.png)

但是在对应网站的加载页面是可以使用js代码去调用接口的

```js
fetch('https://api-test.cbecdc.com/')
  .then(response => {
    // 检查响应状态码是否为200
    if (response.status === 200) {
      // 解析JSON数据
      return response.json();
    } else {
      throw new Error('网络请求错误，状态码：' + response.status);
    }
  })
  .then(data => {
    // 打印JSON数据
    console.log(data);
  })
  .catch(error => {
    // 打印错误信息
    console.error('请求失败:', error);
  });
```

> ![image-20240822104037993](img/4.Nginx配置SSL/image-20240822104037993.png)

通过http请求的方式访问，阿里云会提示备案

![image-20240821174642674](img/4.Nginx配置SSL/image-20240821174642674.png)

解决方式参考阿里云文档

阿里云文档：[域名与服务器不在同一服务商时如何备案_备案(ICP Filing)-阿里云帮助中心 (aliyun.com)](https://help.aliyun.com/zh/icp-filing/basic-icp-service/support/domain-name-and-how-the-server-is-not-in-the-same-service-provider-for-the-record)

<img src="img/4.Nginx配置SSL/image-20240821173956747.png" alt="image-20240821173956747" style="zoom:80%;" />
