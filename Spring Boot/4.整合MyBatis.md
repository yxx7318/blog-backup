# 整合MyBatis

在pom.xml引入依赖

```xml
        <!--整合Mybatis-->
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <!--需指定版本，2.2.0也可以-->
            <version>2.2.2</version>
        </dependency>

        <!--连接mysql的驱动包-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope>
        </dependency>
```

在application.yaml文件中配置数据库连接

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/jdbc?serverTimezone=UTC
    username: root
    password: yuxingxuan
mybatis:
  # 将目标目录下的bean都设置别名，方便后面在xxxMapper.xml中使用
  type-aliases-package: com.atguigu.boot.pojo
  # 开启驼峰命名规则自动转换
  configuration: # 也可以直接加载全局配置文件——classpath:mybatis-config.xml
    map-underscore-to-camel-case: true
```

创建User.java

```java
package com.atguigu.boot.pojo;

import lombok.AllArgsConstructor;
import lombok.Data;

@AllArgsConstructor
@Data
public class User {
    private Integer id;
    private String name;
    private String password;
}
```

创建UserDao.java

```java
package com.atguigu.boot.Dao;

import com.atguigu.boot.pojo.User;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;
import org.apache.ibatis.annotations.Update;

@Mapper //给mapper接口自动生成一个实现类，让Spring对mapper接口的bean进行管理，并且可以省略去写复杂的xml文件
public interface UserDao {

    @Select("select * from users where id = #{id}") //IOC容器会自动匹配使用对应的Bean去匹配
    User selectById(@Param("id") Integer id);

    @Update("update users set name = #{name},password = #{password} where id = #{id}")
    int update(User user);
}
```

> 通过@Mapper可以让IOC容器获取到Mappre接口的实现类，从而通过自动装配可以直接调用

测试功能

```java
    @Resource
    private UserDao userDao;

	@Test
    public void testUserDao(){
        System.out.println(userDao.selectById(2)); //返回查询结果
        System.out.println(userDao.update(new User(2,"jack","123"))); //返回受影响的行数
    }
```

## 关于@Mapper和Mapper.xml

@Mapper和Mapper.xml两者是可以共存的，**只要两者没有同时用在一个方法上**

@Mapper虽然可以简化开发，但是需要**使用`@Select`和`<script>`实现动态sql**，**使用xml的方式可以更为简洁明了的实现动态sql**

与UserDao.java同包名(**默认开启了同包下匹配**)，在resources目录下创建UserDao.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.atguigu.boot.Dao.UserDao">

    <select id="selectById" resultType="User">
        select * from users where id = #{id}
    </select>
</mapper>
```

## 关于entity、domain、vo和pojo的区别

- 在entity包下面的实体类其中的属性会和数据表中的数据类型一一对应，**没有多也没有少**
- 在domain包下面的实体类其中的属性不仅会包含数据库中的字段，**还会包含其他自定义属性**
- 在vo包下面的实体类其中的属性与数据库并没有关系，而是**用来和前端进行交互的数据类**
- 在pojo包下面的实体类并没有严格定义，可以看做**是entity、domain、vo的集合包**

## 注解开发

- `@One`：用于分步查询，将分步查询的结果**映射为一个pojo对象(javaType = User.class)**

  - ```xml
            <!--
                association：处理多对一的映射关系(处理实体类类型的属性)
                    property：设置需要处理映射关系的属性的属性名
                    javaType：设置要处理的属性的类型
            -->
            <association property="dept" javaType="Dept">
                <id column="dept_id" property="deptId"></id>
                <result column="dept_name" property="deptName"></result>
            </association>
    ```

- `@Many`：用于分步查询，将分步查询的结果**保存为集合对象(javaType = List.class)**

  - ```xml
            <!--将查出来的值depy_id作为下一步查询的参数-->
            <collection property="emps"
                        select="com.atguigu.mybatis.mapper.EmpMapper.getDeptAndEmpStepTwo"
                        column="dept_id"></collection>
    ```

- 可以手动映射复杂的pojo对象，但是无法直接处理对象中的查询的结果集(orderList)，即`@Many`注解无法使用`@Result`代替。如果映射对象本身就为结果集(UserAndOrder)，就只要将方法的返回结果定义为List即可

  - ```java
                // 手动映射复杂对象
                // id为true表示为主键
                @Result(id = true, property = "user.id", column = "id"),
                @Result(property = "user.name", column = "name"),
                @Result(property = "user.password", column = "password"),
    ```

UserAndOrder.java

```java
public class UserAndOrder {
    private Integer createUser;
    private User user;
    private List<Order> orderList;
}
```

Mapper.java

```java
    @Select("select id,name,password,create_user FROM tb_users where tb_users.id=#{id}")
    @Results({
            @Result(property = "createUser", column = "create_user"),
            // 手动映射复杂对象
            // id为true表示为主键
//            @Result(id = true, property = "user.id", column = "id"),
//            @Result(property = "user.name", column = "name"),
//            @Result(property = "user.password", column = "password"),

            // 使用分步查询(column代表从数据库提取的字段)
            @Result(property = "user", column = "id",
                    javaType = User.class,
                    one = @One(select = "com.atguigu.boot.Mapper.UserMapper.getUserById")
            ),
            // 映射多个结果集
            @Result(property = "orderList", column = "id",
                    javaType = List.class,
                    many = @Many(select = "com.atguigu.boot.Mapper.UserMapper.getOrderListByUserId")
            )
    })
    UserAndOrder getUserAndOrder(@Param("id") String id);

    @Select("select order_id,user_id,order_name from tb_orders where user_id = #{userId}")
    Order getOrderListByUserId(@Param("userId") String userId);

    @Select("select id,name,password,create_user FROM tb_users where tb_users.id=#{id}")
    User getUserById(@Param("userId") String userId);
```

> ```
> ==>  Preparing: select id,name,password,create_user FROM tb_users where tb_users.id=?
> ==> Parameters: 1(String)
> <==    Columns: id, name, password, create_user
> <==        Row: 1, yuuuuu, 123456, 1
> ====>  Preparing: select id,name,password,create_user FROM tb_users where tb_users.id=?
> ====> Parameters: 1(String)
> <====    Columns: id, name, password, create_user
> <====        Row: 1, yuuuuu, 123456, 1
> <====      Total: 1
> ====>  Preparing: select order_id,user_id,order_name from tb_orders where user_id = ?
> ====> Parameters: 1(String)
> <====    Columns: order_id, user_id, order_name
> <====        Row: 1, 1, 测试
> <====        Row: 2, 1, 测试1
> <====      Total: 2
> <==      Total: 1
> ```
>
> ```json
> {
>     "code": 1,
>     "msg": null,
>     "data": {
>         "createUser": 1,
>         "user": {
>             "id": 1,
>             "name": "yuuuuu",
>             "password": "123456"
>         },
>         "orderList": [
>             {
>                 "orderId": 1,
>                 "userId": 1,
>                 "orderName": "测试"
>             },
>             {
>                 "orderId": 2,
>                 "userId": 1,
>                 "orderName": "测试1"
>             }
>         ]
>     },
>     "map": {}
> }
> ```