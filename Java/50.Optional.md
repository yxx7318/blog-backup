# Optional

> Java 8引入的`Optional<T>`是一个容器对象，用于**优雅处理可能为`null`的值**。其主要目的是：
>
> - 显式提醒开发者处理空值场景
> - 减少`NullPointerException`（NPE）的发生
> - 避免深层嵌套的`if-null`检查，提升代码可读性

## 常用方法

- **创建Optional对象**：
  - `Optional.empty()`：创建一个空的Optional实例
  - `Optional.of(T value)`：创建一个指定非null值的Optional实例，如果value为null则抛出NullPointerException
  - `Optional.ofNullable(T value)`：创建一个可以包含null值的Optional实例。

- **检查值是否存在**：
  - `isPresent()`：如果值存在则返回true，否则返回false
  - `isEmpty()`（Java 11+）：如果值不存在则返回true，否则返回false。

- **获取值**：
  - `get()`：如果值存在则返回该值，否则抛出`NoSuchElementException`。通常建议先检查是否存在，否则使用其他更安全的方法替代

- **条件执行**：
  - `ifPresent(Consumer<? super T> action)`：如果值存在，则使用该值执行给定操作，否则什么也不做
  - `ifPresentOrElse(Consumer<? super T> action, Runnable emptyAction)`（Java 9+）：如果值存在，则使用该值执行给定操作，否则执行空操作。

- **默认值**：
  - `orElse(T other)`：如果值存在则返回该值，否则返回指定的默认值other
  - `orElseGet(Supplier<? extends T> supplier)`：如果值存在则返回该值，否则调用supplier函数并返回其结果
  - `orElseThrow()`（Java 10+）：如果值存在则返回该值，否则抛出`NoSuchElementException`（类似于get()但更语义化）
  - `orElseThrow(Supplier<? extends X> exceptionSupplier)`：如果值存在则返回该值，否则抛出由指定的supplier提供的异常

- **转换值**：
  - `map(Function<? super T, ? extends U> mapper)`：如果值存在，则应用mapper函数并返回其结果的Optional，否则返回一个空Optional
  - `flatMap(Function<? super T, Optional<U>> mapper)`：如果值存在，则应用mapper函数并直接返回其返回的Optional（扁平化），否则返回一个空Optional

- **过滤**：
  - `filter(Predicate<? super T> predicate)`：如果值存在且满足给定断言，则返回包含该值的Optional，否则返回空Optional

- **流操作**（Java 9+）：
  - `stream()`：将Optional转换为一个包含该值（如果存在）或空的Stream

## 示例代码

**创建`Optional`**

```java
// 方法1：明确值非空（否则抛异常）
Optional<String> nonNullOpt = Optional.of("Hello"); 

// 方法2：值可为空
String nullableValue = null;
Optional<String> nullableOpt = Optional.ofNullable(nullableValue);

// 方法3：创建空对象
Optional<String> emptyOpt = Optional.empty();
```

**检查值是否存在**

```java
// 使用 isPresent()
Optional<String> opt = Optional.of("Java");
if (opt.isPresent()) {
    System.out.println(opt.get()); // 输出 "Java"
}

// 未检查的 null 调用（危险！）
String str = getNullableString(); // 可能返回 null
if (str != null) { // 需要显式判空
    System.out.println(str.length());
}
```

**避免`get()`的替代方案**

```java
// 使用 orElse() 提供默认值
Optional<String> empty = Optional.empty();
String value = empty.orElse("Default"); // "Default"

// 未处理的 null 风险
String rawValue = getNullableString();
String result = rawValue != null ? rawValue : "Default"; // 冗长
```

**函数式处理：`ifPresent()`**

```java
// 值存在时执行操作
Optional<String> opt = Optional.of("Hi");
opt.ifPresent(v -> System.out.println(v.toUpperCase())); // 输出 "HI"

// 传统判空写法
String val = getNullableString();
if (val != null) {
    System.out.println(val.toUpperCase());
}
```

**链式转换：`map()`与 `flatMap()`**

```java
class User {
    private Address address;
    public Optional<Address> getAddress() { 
        return Optional.ofNullable(address);
    }
}

class Address {
    private String city;
    public Optional<String> getCity() {
        return Optional.ofNullable(city);
    }
}

Optional<User> userOpt = Optional.ofNullable(someUser);

// 组合使用map+flatMap解包嵌套Optional
String cityUpper = userOpt
    .flatMap(User::getAddress)  // 解包Address的Optional
    .flatMap(Address::getCity) // 解包City的Optional
    .map(String::toUpperCase)  // 转换非空值
    .orElse("UNKNOWN");        // 最终兜底

// 错误！出现双层Optional：Optional<Optional<String>>
Optional<Optional<String>> badResult = userOpt
    .map(user -> user.getAddress()
        .map(Address::getCity)); // 产生 Optional<Optional<String>>

// 传统写法
String cityUpper;
if (someUser != null) {
    Address addr = someUser.getAddress();
    if (addr != null) {
        String city = addr.getCity();
        if (city != null) {
            cityUpper = city.toUpperCase();
        } else {
            cityUpper = "UNKNOWN";
        }
    } else {
        cityUpper = "UNKNOWN";
    }
} else {
    cityUpper = "UNKNOWN";
}
```

**条件过滤：`filter()`**

```java
// 只处理长度大于 3 的字符串
Optional<String> opt = Optional.of("Java");
opt.filter(s -> s.length() > 3)
   .ifPresent(System.out::println); // 输出 "Java"

// 传统条件+判空
String s = getNullableString();
if (s != null && s.length() > 3) {
    System.out.println(s);
}
```

**异常处理：`orElseThrow()`**

```java
// 为空时抛自定义异常
Optional<String> empty = Optional.empty();
String val = empty.orElseThrow(
    () -> new IllegalArgumentException("值缺失！")
);

// 手动抛异常
String raw = getNullableString();
if (raw == null) {
    throw new IllegalArgumentException("值缺失！");
}
```