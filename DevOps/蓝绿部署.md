# 蓝绿部署

> **蓝绿部署是一种将新版本的应用部署在一个全新的环境中，待测试通过后再切换流量到新环境的部署方式**。 在蓝绿部署中，原有的稳定版本称为蓝环境，而新版本所在的环境称为绿环境。 通过切换路由或负载均衡器的方式，将用户的流量从蓝环境切换到绿环境，从而完成版本更新

## SpringBoot项目

> - Linux系统服务配置
> - Nginx不间断发布和负载均衡

### 系统服务配置

> 用于注册Springboot服务，并在启动服务前进行日志文件的重命名并锁定进程服务，防止异常杀死

日志重命名脚本`RotateLog.sh`：

```sh
#!/bin/bash

# 获取脚本所在的目录
SCRIPT_DIR=$(dirname "$(readlink -f "$0")")

# 封装日志文件重命名和创建新日志文件的函数
rotate_log_file() {
    local log_file="$1"
    local log_dir=$(dirname "$log_file")
    local log_base=$(basename "$log_file")
    local log_name="${log_base%.*}"  # 移除文件扩展名

    # 检查并创建 logs 子目录
    local log_subdir="${log_dir}/logs"
    mkdir -p "$log_subdir"

    # 检查是否需要重命名旧日志文件
    if [ -f "$log_file" ]; then
        # 获取当前时间戳
        local timestamp=$(date +"%Y%m%d-%H%M%S")
        # 重命名旧日志文件，添加时间戳后缀，并移动到 logs 子目录
        mv "$log_file" "${log_subdir}/${log_name}_${timestamp}.log"
    fi

    # 创建新日志文件
    touch "$log_file"

    # 设置正确的权限，以便服务可以写入日志文件
    # 请根据实际情况替换 springboot:springboot 为正确的用户和组
    # chown springboot:springboot "$log_file"
    echo "$log_file"
}

# 检查是否提供了日志文件路径作为参数
if [ $# -eq 0 ]; then
    # 如果没有提供日志文件路径，使用脚本所在目录
    LOG_FILE_PATH=$(find "$SCRIPT_DIR" -maxdepth 1 -name "*.log" -print -quit)
    if [ -z "$LOG_FILE_PATH" ]; then
        echo "脚本目录$SCRIPT_DIR没有查找到任何.log文件，您可以手动指定: sh $0 LOG_FILE_PATH"
    elif [ ! -z "$LOG_FILE_PATH" ]; then
        rotate_log_file "$LOG_FILE_PATH"
    fi
else
    # 如果提供了日志文件路径，使用该路径
    LOG_FILE_PATH="$1"
    # 调用函数，传递日志文件路径
    rotate_log_file "$LOG_FILE_PATH"
fi
```

> 添加权限：`chmod +x rotateLog.sh`

生成系统服务配置文件：`vim /lib/systemd/system/spring.service`

```ini
[Unit]
Description=springboot daemon
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/usr/local/springboot
ExecStartPre=/bin/sh -c 'source $(find "/usr/local/springboot" -maxdepth 1 -name "*.sh" -print -quit)'  # 指定启动前的脚本，重启时也会触发
ExecStart=/bin/sh -c '/usr/local/jdk/bin/java -jar $(find "/usr/local/springboot" -maxdepth 1 -name "*.jar" -print -quit) --server.port=7318 --spring.profiles.active=prod >> /usr/local/springboot/log.log 2>&1'
ExecStop=/bin/kill -TERM $MAINPID
ExecStopPost=/bin/sleep 3
TimeoutStopSec=10
Restart=always
RestartSec=1
# 较低版本的systemctl不支持
# StandardOutput=append:${SPRINGBOOT_PATH}/systemLogs/system-${SERVICE_NAME}-info.log
# StandardError=append:${SPRINGBOOT_PATH}/systemLogs/system-${SERVICE_NAME}-error.log
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

> 系统服务构建脚本`ProduceSpringBootSystemd.sh`：
>
> ```sh
> #!/bin/sh
> 
> # 检查是否提供了springboot的路径参数
> if [ $# -eq 0 ]; then
>     echo "使用方式: sh $0 SPRINGBOOT_PATH [SERVICE_NAME]"
>     return 1
> fi
> 
> # 可能需要修改定制的参数
> JAVA_HOME="/usr/local/jdk"
> PORT=7318
> ACTIVE="prod"
> 
> SPRINGBOOT_PATH="$1"
> SERVICE_NAME="${2:-springboot}"  # 如果第二个参数未提供，则默认服务名称为'springboot'
> 
> rm -f /lib/systemd/system/${SERVICE_NAME}.service
> 
> # mkdir -p ${SPRINGBOOT_PATH}/systemLogs
> 
> touch /lib/systemd/system/${SERVICE_NAME}.service
> 
> cat <<EOF > /lib/systemd/system/${SERVICE_NAME}.service
> [Unit]
> Description=springboot daemon
> After=network.target
> 
> [Service]
> Type=simple
> User=root
> WorkingDirectory=${SPRINGBOOT_PATH}
> ExecStartPre=/bin/sh -c 'sh $(find "${SPRINGBOOT_PATH}" -maxdepth 1 -name "*.sh" -print -quit)'
> ExecStart=/bin/sh -c '${JAVA_HOME}/bin/java -jar $(find "${SPRINGBOOT_PATH}" -maxdepth 1 -name "*.jar" -print -quit) --server.port=${PORT} --spring.profiles.active=${ACTIVE} >> "${SPRINGBOOT_PATH}"/log.log 2>&1'
> ExecStop=/bin/kill -TERM ${MAINPID}
> ExecStopPost=/bin/sleep 3
> TimeoutStopSec=10
> Restart=always
> RestartSec=1
> # 较低版本的systemctl不支持
> # StandardOutput=append:${SPRINGBOOT_PATH}/systemLogs/system-${SERVICE_NAME}-info.log
> # StandardError=append:${SPRINGBOOT_PATH}/systemLogs/system-${SERVICE_NAME}-error.log
> PrivateTmp=true
> 
> [Install]
> WantedBy=multi-user.target
> EOF
> 
> # 重新加载systemd以应用新的服务单元文件
> sudo systemctl daemon-reload
> 
> echo "服务文件 ${SERVICE_NAME}.service 已创建并重新加载。"
> ```

### Nginx配置文件

```nginx
    upstream springboot {
        server localhost:7318 weight=10;
        server localhost:7319 weight=0;
    }


    server {
        listen 80;

        location / {
			proxy_set_header Host $http_host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header REMOTE-HOST $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_pass http://springboot/;
        }
    }
```

