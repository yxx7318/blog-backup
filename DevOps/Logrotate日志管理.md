# Logrotate日志管理

> Logrotate是一个广泛应用于Linux系统中的日志管理工具，旨在帮助系统管理员自动轮转、压缩、删除和归档日志文件。随着应用程序的运行，日志文件会不断增长，如果不加以管理，可能会导致磁盘空间耗尽，甚至影响系统的性能。Logrotate通过定期处理日志文件，确保日志不会无限增长，同时保留必要的历史记录以供后续分析

## 主要的功能

- 日志轮转（Log Rotation）：定期将当前的日志文件重命名为带有日期或其他标识的文件，防止日志文件过大
- 压缩旧日志：将旧的日志文件压缩为 `.gz` 或其他格式，节省磁盘空间
- 删除过期日志：根据配置，删除超过指定天数或数量的日志文件，避免日志文件占用过多存储空间
- 通知应用程序重新打开日志文件：在日志轮转后，发送信号给应用程序（如 Nginx、Apache 等），通知它们重新打开新的日志文件，确保日志继续写入新文件中
- 支持自定义脚本：可以在日志轮转前后执行自定义脚本，例如备份、清理或发送通知等操作

## 重要参数

> Logrotate 的配置文件通常位于`/etc/logrotate.conf`或`/etc/logrotate.d/`目录下。每个应用程序可以有自己独立的配置文件，定义特定的日志轮转规则

- `daily`、 `weekly`、`monthly`：指定日志轮转的频率
  - `daily`：每天轮转一次日志文件
  - `weekly`：每周轮转一次日志文件
  - `monthly`：每月轮转一次日志文件

- `rotate <count>`：指定保留的历史日志文件数量。当达到指定数量时，最早的日志文件将被删除

- `compress`：启用日志文件的压缩功能。旧的日志文件将被压缩为`.gz`格式，节省磁盘空间
- `delaycompress`：延迟一天压缩日志文件。这意味着当天的日志文件不会立即被压缩，而是在下一次轮转时才进行压缩，确保当前日志文件不会因为压缩而无法读取
- `notifempty`：如果日志文件为空，则不进行轮转。这可以避免创建不必要的空日志文件
- `missingok`：如果指定的日志文件不存在，Logrotate不会报错并继续处理其他日志文件。这可以防止因日志文件暂时缺失而导致整个轮转过程失败
- `create <mode> <owner> <group>`：在轮转后创建新的日志文件，并设置其权限、所有者和组。这对于确保新日志文件具有正确的权限和所有权非常重要
  - `<mode>`：文件权限，使用八进制表示（如 `0640`）
  - `<owner>`：文件的所有者（用户名）
  - `<group>`：文件的所属组（组名）
- `dateext`：在轮转后的日志文件名中添加日期扩展名。例如，`access.log`轮转后会变成`access.log-20241215`，方便识别不同日期的日志文件
- `sharedscripts`：只有在最后一次轮转时执行`prerotate`和`postrotate`脚本。这对于多个匹配的日志文件（如通配符 `*.log`）非常有用，避免每个日志文件都执行一次脚本
- `prerotate`和`postrotate`：分别在日志轮转之前和之后执行自定义脚本。这些脚本可以用于执行预处理或后处理操作，例如备份、清理、发送通知等
  - `prerotate`：在日志轮转之前执行的脚本
  - `postrotate`：在日志轮转之后执行的脚本
- `size <size>`：根据日志文件的大小来触发轮转，而不是依赖于时间。可以指定一个文件大小阈值，当日志文件达到该大小时，Logrotate会自动进行轮转
- `olddir <directory>`：将旧的日志文件移动到指定的目录中。可以将历史日志文件集中存放在一个特定的目录中，便于管理和备份
- `copytruncate`：在轮转时复制当前的日志文件，并截断（清空）原文件。适用于那些无法通过发送信号让应用程序重新打开日志文件的情况

## 基本命令

调试模式命令：

```
sudo logrotate -d /etc/logrotate.conf
```

> `-d`参数模拟整个流程，但不会实际修改文件

强制轮询命令：

```
sudo logrotate -f /etc/logrotate.conf
```

## 示例配置

```
vim /etc/logrotate.d/nginx
```

配置示例：

```
/var/log/nginx/*.log {     # 匹配/var/log/nginx/目录下所有以.log结尾的文件
    daily                  # 每天轮转一次日志文件
    rotate 7               # 保留 7 天的历史日志文件（根据实际需求调整）
    compress               # 将旧的日志文件压缩为 .gz 格式
    delaycompress          # 延迟一天压缩日志文件，确保当前日志文件不会被立即压缩
    notifempty             # 如果日志文件为空，不进行轮转
    missingok              # 如果日志文件不存在，不报错并继续处理其他日志文件
    # create 0640 www-data adm  # 创建新的日志文件时，设置权限为 0640，所有者为 www-data，组为 adm
    dateext                # 在轮转后的日志文件名中添加日期扩展名（例如 access.log-20241215）
    sharedscripts          # 只在最后一次轮转时执行 postrotate 脚本，避免每个日志文件都执行一次脚本
    postrotate             # 在日志轮转之后执行的脚本
        [ -e /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`  # 通知 Nginx 重新打开日志文件（直接发送 USR1 信号）
    endscript
}
```

> - Nginx安装时自动生成：在某些Linux发行版中，当你安装Nginx时，包管理器（如`apt`、`yum`）会自动创建`/etc/logrotate.d/nginx`文件，并配置好基本的日志轮转规则。这是为了确保Nginx的日志文件能够被自动管理，而不需要用户手动配置
> - 手动创建：如果你是通过源码编译安装Nginx，或者安装过程中没有自动创建该文件，可以手动创建`/etc/logrotate.d/nginx`文件，并根据需要配置日志轮转规则